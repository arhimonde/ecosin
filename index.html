import React, { useState, useEffect } from 'react';

// Importar iconos de lucide-react
import { Cloud, Leaf, Gauge, Award, Lightbulb, MapPin, Mail, Phone, Thermometer, Droplets, CloudDrizzle, Brain, Trophy, Camera, Menu, X, UserPlus, LogIn, ArrowLeft, Zap, CalendarCheck, Calculator, Users, Eye } from 'lucide-react';

// Firebase imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, limit } from 'firebase/firestore';

// Componente principal de la aplicación
const App = () => {
  // Estado para la configuración de Firebase
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [userId, setUserId] = useState('Cargando ID de usuario...');
  const [iotData, setIotData] = useState([]);
  const [loading, setLoading] = useState(true);
  const [message, setMessage] = useState(''); // Para mensajes al usuario

  // Estados para la funcionalidad de ML (Recomendaciones)
  const [mlPrompt, setMlPrompt] = useState('');
  const [mlResponse, setMlResponse] = useState('');
  const [mlLoading, setMlLoading] = useState(false);
  const [mlMessage, setMlMessage] = useState('');

  // Estados para la funcionalidad de Generador de Desafíos Ecológicos (Nueva función ML)
  const [challengePrompt, setChallengePrompt] = useState('');
  const [challengeResponse, setChallengeResponse] = useState('');
  const [challengeLoading, setChallengeLoading] = useState(false);
  const [challengeMessage, setChallengeMessage] = useState('');

  // Estados para el Generador de Ideas de Eventos Sostenibles (Nueva función ML)
  const [eventPrompt, setEventPrompt] = useState('');
  const [eventResponse, setEventResponse] = useState('');
  const [eventLoading, setEventLoading] = useState(false);
  const [eventMessage, setEventMessage] = useState('');

  // Estado para la simulación de Realidad Aumentada
  const [isARActivated, setIsARActivated] = useState(false);
  const [selectedARLocation, setSelectedARLocation] = useState('Parque Central'); // Default location for AR simulation

  // Estado para la barra de navegación móvil (hamburguesa)
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);

  // Estados para la funcionalidad de Registro/Login
  const [registerEmail, setRegisterEmail] = useState('');
  const [registerPassword, setRegisterPassword] = useState('');
  const [registerLoading, setRegisterLoading] = useState(false);
  const [registerMessage, setRegisterMessage] = useState('');
  const [currentView, setCurrentView] = useState('home'); // 'home', 'register', 'login', 'iotMonitor', 'ecoChallengeGenerator', 'ecoEventGenerator', 'detailedOverview', 'featuresDetailedPage'

  // Global variables provided by the Canvas environment
  const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
  const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
  const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 

  // Initialize Firebase and authenticate
  useEffect(() => {
    const initFirebase = async () => {
      try {
        const app = initializeApp(firebaseConfig);
        const firestore = getFirestore(app);
        const firebaseAuth = getAuth(app);

        setDb(firestore);
        setAuth(firebaseAuth);

        // Sign in using custom token or anonymously
        if (initialAuthToken) {
          await signInWithCustomToken(firebaseAuth, initialAuthToken);
        } else {
          await signInAnonymously(firebaseAuth);
        }

        onAuthStateChanged(firebaseAuth, (user) => {
          if (user) {
            setUserId(user.uid);
          } else {
            setUserId('No autenticado / ID de usuario anónimo');
          }
        });

      } catch (error) {
        console.error("Error al inicializar Firebase o autenticar:", error);
        setMessage("Error al cargar la aplicación. Por favor, inténtalo de nuevo más tarde.");
      } finally {
        setLoading(false);
      }
    };

    initFirebase();
  }, []); // Empty dependency array means this runs once on mount

  // Listen for real-time IoT data updates from Firestore
  useEffect(() => {
    if (db && userId && userId !== 'Cargando ID de usuario...' && userId !== 'No autenticado / ID de usuario anónimo') {
      const iotReadingsCollectionRef = collection(db, `artifacts/${appId}/public/data/iot_readings`);
      // Order by timestamp and limit to latest 10 for display
      const q = query(iotReadingsCollectionRef, orderBy('timestamp', 'desc'), limit(10));

      const unsubscribe = onSnapshot(q, (snapshot) => {
        const newIotData = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        setIotData(newIotData);
        setMessage(''); // Clear any previous messages
      }, (error) => {
        console.error("Error al escuchar datos IoT:", error);
        setMessage("Error al cargar los datos IoT. Por favor, recarga la página.");
      });

      // Cleanup listener on component unmount
      return () => unsubscribe();
    }
  }, [db, userId, appId]); // Re-run if db or userId changes

  // Function to simulate sending new IoT data
  const simulateIotReading = async () => {
    if (!db || !userId) {
      setMessage("La base de datos no está lista o el usuario no está autenticado.");
      return;
    }
    setLoading(true);
    try {
      const co2 = (Math.random() * (700 - 350) + 350).toFixed(2); // ppm
      const temperature = (Math.random() * (30 - 15) + 15).toFixed(2); // °C
      const humidity = (Math.random() * (80 - 40) + 40).toFixed(2); // %

      await addDoc(collection(db, `artifacts/${appId}/public/data/iot_readings`), {
        co2: parseFloat(co2),
        temperature: parseFloat(temperature),
        humidity: parseFloat(humidity),
        timestamp: serverTimestamp(),
        userId: userId // Storing the userId who added this data
      });
      setMessage("Lectura IoT simulada enviada con éxito.");
    } catch (error) {
      console.error("Error al simular lectura IoT:", error);
      setMessage("Error al enviar la lectura IoT simulada. Inténtalo de nuevo.");
    } finally {
      setLoading(false);
    }
  };

  // Function to call the LLM for ML-powered recommendations
  const getMlRecommendation = async () => {
    if (!mlPrompt.trim()) {
      setMlMessage("Por favor, introduce una pregunta o escenario para la recomendación ML.");
      return;
    }

    setMlLoading(true);
    setMlResponse('');
    setMlMessage('');

    let chatHistory = [];
    // Construct the prompt for the LLM based on user input
    chatHistory.push({ role: "user", parts: [{ text: `Genera una recomendación o idea relacionada con la sostenibilidad o el medio ambiente basada en el siguiente escenario: "${mlPrompt}". Sé conciso y práctico.` }] });
    const payload = { contents: chatHistory };
    const apiKey = ""; // Leave as empty string for Canvas runtime to provide
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        setMlResponse(text);
      } else {
        setMlMessage("No se pudo obtener una recomendación. Inténtalo de nuevo.");
        console.error("Respuesta inesperada del LLM:", result);
      }
    } catch (error) {
      console.error("Error al llamar al modelo de ML:", error);
      setMlMessage("Hubo un error al procesar tu solicitud ML. Por favor, inténtalo de nuevo.");
    } finally {
      setMlLoading(false);
    }
  };

  // Function to generate an eco-challenge using LLM
  const generateEcoChallenge = async () => {
    if (!challengePrompt.trim()) {
      setChallengeMessage("Por favor, describe qué tipo de desafío ambiental te gustaría.");
      return;
    }

    setChallengeLoading(true);
    setChallengeResponse('');
    setChallengeMessage('');

    let chatHistory = [];
    // Prompt the LLM to generate an eco-challenge
    chatHistory.push({ role: "user", parts: [{ text: `Genera un desafío ecológico creativo y accionable basado en el siguiente tema o interés: "${challengePrompt}". Incluye pasos concretos y un objetivo claro. Presenta el desafío en un formato amigable para una aplicación de gamificación.` }] });
    const payload = { contents: chatHistory };
    const apiKey = ""; // Leave as empty string for Canvas runtime to provide
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        setChallengeResponse(text);
      } else {
        setChallengeMessage("No se pudo generar un desafío. Inténtalo de nuevo.");
        console.error("Respuesta inesperada del LLM:", result);
      }
    } catch (error) {
      console.error("Error al llamar al modelo para el desafío:", error);
      setChallengeMessage("Hubo un error al generar el desafío. Por favor, inténtalo de nuevo.");
    } finally {
      setChallengeLoading(false);
    }
  };

  // Function to generate eco-event ideas using LLM
  const generateEcoEventIdea = async () => {
    if (!eventPrompt.trim()) {
      setEventMessage("Por favor, describe el tipo de evento ecológico que te gustaría organizar.");
      return;
    }

    setEventLoading(true);
    setEventResponse('');
    setEventMessage('');

    let chatHistory = [];
    // Prompt the LLM to generate eco-event ideas
    chatHistory.push({ role: "user", parts: [{ text: `Genera una idea de evento sostenible creativo para la comunidad basado en el siguiente tema o interés: "${eventPrompt}". Incluye un nombre para el evento, una breve descripción, algunas actividades clave y un objetivo de impacto. Presenta la idea en un formato claro para una aplicación de gestión de eventos.` }] });
    const payload = { contents: chatHistory };
    const apiKey = ""; // Leave as empty string for Canvas runtime to provide
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        const text = result.candidates[0].content.parts[0].text;
        setEventResponse(text);
      } else {
        setEventMessage("No se pudo generar la idea de evento. Inténtalo de nuevo.");
        console.error("Respuesta inesperada del LLM para evento:", result);
      }
    } catch (error) {
      console.error("Error al llamar al modelo para el evento:", error);
      setEventMessage("Hubo un error al generar la idea de evento. Por favor, inténtalo de nuevo.");
    } finally {
      setEventLoading(false);
    }
  };


  // Handler for mobile menu link clicks to close the menu and navigate
  const handleNavLinkClick = (view, sectionId = 'inicio') => {
    setIsMobileMenuOpen(false);
    setCurrentView(view);
    // Scroll to section if it's the home view and a specific section is provided
    if (view === 'home' && sectionId) {
      setTimeout(() => {
        const section = document.getElementById(sectionId);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth' });
        }
      }, 100); // Small delay to allow view change and then scroll
    } else {
      // For other views (register, login, etc. or a new page like detailedOverview), scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  // Handle user registration
  const handleRegister = async (e) => {
    e.preventDefault(); // Prevent default form submission
    if (!auth) {
      setRegisterMessage("La autenticación no está inicializada.");
      return;
    }
    setRegisterLoading(true);
    setRegisterMessage('');
    try {
      await createUserWithEmailAndPassword(auth, registerEmail, registerPassword);
      setRegisterMessage("¡Registro exitoso! Ya puedes iniciar sesión.");
      setRegisterEmail('');
      setRegisterPassword('');
      // Optionally switch to login view or home
      setCurrentView('home'); 
    } catch (error) {
      console.error("Error al registrar:", error);
      let msg = "Error al registrar. Por favor, inténtalo de nuevo.";
      if (error.code === 'auth/email-already-in-use') {
        msg = 'El correo electrónico ya está en uso.';
      } else if (error.code === 'auth/invalid-email') {
        msg = 'El formato del correo electrónico no es válido.';
      } else if (error.code === 'auth/weak-password') {
        msg = 'La contraseña debe tener al menos 6 caracteres.';
      }
      setRegisterMessage(msg);
    } finally {
      setRegisterLoading(false);
    }
  };

  // Render content based on currentView state
  const renderContent = () => {
    switch (currentView) {
      case 'home':
        return (
          <>
            {/* Hero Section */}
            <section id="inicio" className="relative flex flex-col items-center justify-center text-center py-20 px-4 min-h-[60vh] rounded-b-3xl overflow-hidden">
                {/* Video Background - Using a royalty-free nature video */}
                <video
                    className="absolute inset-0 w-full h-full object-cover z-0"
                    src="https://assets.mixkit.co/videos/preview/mixkit-forest-and-mountains-in-the-fog-27515-large.mp4" // Example royalty-free video from Mixkit
                    autoPlay
                    loop
                    muted
                    playsInline
                >
                    Your browser does not support the video tag.
                </video>
                {/* Overlay for text readability */}
                <div className="absolute inset-0 bg-gradient-to-t from-green-800/70 to-blue-700/60 rounded-b-3xl z-10"></div>
                <div className="relative z-20 text-white max-w-3xl"> {/* Text color set to white */}
                  <h2 className="text-4xl md:text-5xl font-extrabold leading-tight mb-4 drop-shadow-md">
                    Ecosín Digital: Catalizando la Acción Climática Local
                  </h2>
                  <p className="text-lg md:text-xl mb-8 opacity-90 drop-shadow-sm">
                    Una plataforma innovadora que empodera a ciudadanos y gobiernos en la lucha contra el cambio climático, transformando la conciencia en acción medible.
                  </p>
                  <button 
                    onClick={() => handleNavLinkClick('detailedOverview')} // Updated to new detailed page
                    className="bg-white text-green-700 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transition duration-300 transform hover:scale-105"
                  >
                    ¡Descubre cómo!
                  </button>
              </div>
            </section>

            {/* About Section (Summary on Home Page) */}
            <section id="sobre-ecosín" className="container mx-auto py-16 px-4">
              <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center">
                <h3 className="text-3xl font-bold text-green-700 mb-6">¿Qué es Ecosín Digital?</h3>
                <p className="text-lg text-gray-700 leading-relaxed max-w-3xl mx-auto">
                  Ecosín Digital es una plataforma innovadora diseñada para empoderar a los ciudadanos y gobiernos locales en la lucha contra el cambio climático. Utilizando tecnologías de vanguardia, convertimos la acción sostenible en una experiencia interactiva y gratificante. Nuestro objetivo es fomentar hábitos más ecológicos y transparentes, construyendo comunidades más verdes y conscientes.
                </p>
              </div>
            </section>

            {/* Features Section (Summary on Home Page, links to detailed page) */}
            <section id="caracteristicas" className="container mx-auto py-16 px-4">
              <h3 className="text-3xl font-bold text-center text-green-700 mb-12">Nuestras Características Clave</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {/* Feature Card 1: Monitorización Ambiental */}
                <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition duration-300">
                  <Cloud className="text-blue-500 h-16 w-16 mb-4" />
                  <h4 className="text-xl font-semibold text-gray-800 mb-3">Monitorización Ambiental en Tiempo Real</h4>
                  <p className="text-gray-600">
                    Sensores IoT recogen datos clave de calidad del aire, ruido y temperatura, mostrándolos en mapas interactivos.
                  </p>
                </div>

                {/* Feature Card 2: Recomendaciones Personalizadas */}
                <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition duration-300">
                  <Lightbulb className="text-yellow-500 h-16 w-16 mb-4" />
                  <h4 className="text-xl font-semibold text-gray-800 mb-3">Recomendaciones Personalizadas</h4>
                  <p className="text-gray-600">
                    Gracias al Machine Learning, la app ofrece sugerencias adaptadas para reducir tu huella de carbono.
                  </p>
                </div>

                {/* Feature Card 3: Gamificación */}
                <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition duration-300">
                  <Award className="text-purple-500 h-16 w-16 mb-4" />
                  <h4 className="text-xl font-semibold text-gray-800 mb-3">Gamificación para la Acción</h4>
                  <p className="text-gray-600">
                    Gana puntos, insignias y sube de nivel al completar desafíos sostenibles. ¡Haz que cuidar el planeta sea divertido!
                  </p>
                </div>

                {/* Feature Card 4: Realidad Aumentada */}
                <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition duration-300">
                  <Gauge className="text-red-500 h-16 w-16 mb-4" /> {/* Using Gauge as a placeholder for AR icon */}
                  <h4 className="text-xl font-semibold text-gray-800 mb-3">Experiencias Inmersivas con Realidad Aumentada</h4>
                  <p className="text-gray-600">
                    Visualiza el impacto ambiental y explora tu entorno de una forma nueva a través de la RA.
                  </p>
                </div>

                {/* Feature Card 5: Calculadora de Huella */}
                <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition duration-300">
                  <Calculator className="text-green-500 h-16 w-16 mb-4" />
                  <h4 className="text-xl font-semibold text-gray-800 mb-3">Calculadora de Huella de Carbono</h4>
                  <p className="text-gray-600">
                    Calcula y monitorea tu impacto personal, estableciendo objetivos para un futuro más verde.
                  </p>
                </div>

                {/* Feature Card 6: Comunidad y Eventos */}
                <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform hover:scale-105 transition duration-300">
                  <Users className="text-orange-500 h-16 w-16 mb-4" />
                  <h4 className="text-xl font-semibold text-gray-800 mb-3">Comunidad y Eventos Locales</h4>
                  <p className="text-gray-600">
                    Participa en eventos, conéctate con otros usuarios y forma parte de una comunidad activa.
                  </p>
                </div>
              </div>
              {/* Button to go to detailed features page */}
              <div className="text-center mt-12">
                <button 
                  onClick={() => handleNavLinkClick('featuresDetailedPage')}
                  className="bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 flex items-center justify-center mx-auto"
                >
                  <Eye className="h-5 w-5 mr-2" /> Explora todas las características
                </button>
              </div>
            </section>

            {/* Gamification Section (Summary on Home Page) */}
            <section id="gamificacion" className="container mx-auto py-16 px-4">
              <h3 className="text-3xl font-bold text-center text-green-700 mb-12">Gamificación: ¡Haz que la Sostenibilidad sea un Juego!</h3>
              <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center">
                <Trophy className="text-amber-500 h-20 w-20 mb-6 mx-auto" />
                <p className="text-lg text-gray-700 leading-relaxed max-w-3xl mx-auto mb-8">
                  En Ecosín Digital, transformamos la acción climática en una experiencia divertida y gratificante.
                  Gana **puntos** al completar desafíos sostenibles (ej. reciclar correctamente, usar transporte público).
                  Sube de **nivel** a medida que tu impacto positivo crece, desbloqueando nuevas **insignias** que reconocen tus logros.
                  Compite amistosamente en **tablas de clasificación** y únete a **desafíos grupales** para alcanzar metas comunitarias.
                  ¡Cada acción cuenta y te acerca a ser un verdadero Héroe Verde de tu ciudad!
                </p>
                <div className="flex flex-col md:flex-row justify-center items-center space-y-4 md:space-y-0 md:space-x-8">
                  <div className="bg-green-100 p-6 rounded-xl shadow-md flex flex-col items-center">
                    <span className="text-4xl font-bold text-green-700">Nivel 5</span>
                    <p className="text-gray-600">Explorador Verde</p>
                  </div>
                  <div className="bg-blue-100 p-6 rounded-xl shadow-md flex flex-col items-center">
                    <span className="text-4xl font-bold text-blue-700">1250 Puntos</span>
                    <p className="text-gray-600">Impacto Acumulado</p>
                  </div>
                  <div className="bg-purple-100 p-6 rounded-xl shadow-md flex flex-col items-center">
                    <span className="text-4xl font-bold text-purple-700">5 Insignias</span>
                    <p className="text-gray-600">Logros Destacados</p>
                  </div>
                </div>
              </div>
            </section>

            {/* Realidad Aumentada Section (Summary on Home Page) */}
            <section id="realidad-aumentada" className="container mx-auto py-16 px-4">
              <h3 className="text-3xl font-bold text-center text-green-700 mb-12">Realidad Aumentada: Educación Inmersiva para la Sostenibilidad</h3>
              <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center relative">
                <Camera className="text-indigo-500 h-20 w-20 mb-6 mx-auto" />
                <p className="text-lg text-gray-700 leading-relaxed max-w-3xl mx-auto mb-8">
                  Nuestra función de Realidad Aumentada te permite interactuar con el mundo real de una forma única.
                  Escanea elementos de tu ciudad para visualizar información ambiental, aprender sobre su impacto
                  y descubrir formas de contribuir a un entorno más verde. ¡La sostenibilidad cobra vida ante tus ojos!
                </p>

                <div className="mb-6">
                  <label htmlFor="ar-location" className="block text-gray-700 text-lg font-medium mb-2">
                    Selecciona una Ubicación Simulada para RA:
                  </label>
                  <select
                    id="ar-location"
                    className="w-full md:w-1/2 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                    value={selectedARLocation}
                    onChange={(e) => {
                      setSelectedARLocation(e.target.value);
                      setIsARActivated(false); // Reset AR activation when location changes
                    }}
                  >
                    <option value="Parque Central">Parque Central</option>
                    <option value="Zona Residencial">Zona Residencial</option>
                    <option value="Centro Histórico">Centro Histórico</option>
                  </select>
                </div>

                <div className="relative w-full max-w-xl mx-auto rounded-xl overflow-hidden shadow-lg mb-8">
                  <img
                    src="https://placehold.co/800x450/E0F2F1/000000?text=Escena+Urbana"
                    alt="Escena urbana sin RA"
                    className="w-full h-auto object-cover rounded-xl"
                  />
                  {isARActivated && (
                    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-40 rounded-xl transition-opacity duration-500 opacity-100">
                      <div className="bg-white text-gray-800 p-4 rounded-lg shadow-xl max-w-xs text-sm transform -translate-y-1/2">
                        <p className="font-bold text-green-600 mb-1">
                          {selectedARLocation === 'Parque Central' && '¡Árbol Nativo en el Parque!'}
                          {selectedARLocation === 'Zona Residencial' && '¡Contenedor de Reciclaje Cercano!'}
                          {selectedARLocation === 'Centro Histórico' && '¡Edificio Histórico con Potencial de Eficiencia!'}
                        </p>
                        <p>
                          {selectedARLocation === 'Parque Central' && 'Este árbol absorbe aproximadamente 22 kg de CO2 al año.'}
                          {selectedARLocation === 'Zona Residencial' && 'Deposita aquí plásticos y envases para un futuro más limpio.'}
                          {selectedARLocation === 'Centro Histórico' && 'Este edificio podría reducir su consumo energético con mejoras en aislamiento.'}
                        </p>
                        <p className="text-xs text-gray-500 mt-2">
                          {selectedARLocation === 'Parque Central' && 'Planta un árbol virtual para ver tu impacto.'}
                          {selectedARLocation === 'Zona Residencial' && 'La RA te guía a los puntos de reciclaje.'}
                          {selectedARLocation === 'Centro Histórico' && 'La RA muestra el potencial de ahorro energético.'}
                        </p>
                      </div>
                    </div>
                  )}
                  {!isARActivated && (
                    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 rounded-xl transition-opacity duration-500 opacity-0 hover:opacity-100 cursor-pointer"
                        onClick={() => setIsARActivated(true)}>
                      <button className="bg-white text-green-700 font-bold py-3 px-6 rounded-full shadow-lg hover:bg-gray-100 transition duration-300 transform hover:scale-105">
                        Activar Vista RA
                      </button>
                    </div>
                  )}
                </div>
                <button
                  onClick={() => setIsARActivated(!isARActivated)}
                  className="bg-indigo-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-105"
                >
                  {isARActivated ? 'Desactivar Vista RA' : 'Activar Vista RA'}
                </button>
              </div>
            </section>

            {/* IoT Data Section (Summary on Home Page) */}
            <section id="iot-data" className="container mx-auto py-16 px-4">
              <h3 className="text-3xl font-bold text-center text-green-700 mb-12">Datos Ambientales IoT (Simulados)</h3>
              <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center relative">
                {message && (
                  <div className={`mb-4 p-3 rounded-lg text-white ${message.includes('Error') ? 'bg-red-500' : 'bg-green-500'}`}>
                    {message}
                  </div>
                )}
                <p className="text-sm text-gray-500 mb-4 text-center">
                  **ID de Usuario:** {userId} (Este ID se utiliza para identificar tus datos en nuestra base de datos simulada y es visible a otros usuarios.)
                </p>
                <div className="flex justify-center items-center space-x-6 mb-8">
                  <button
                    onClick={simulateIotReading}
                    disabled={loading || !db || !userId || userId === 'Cargando ID de usuario...'}
                    className="bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading ? 'Enviando...' : 'Simular Nueva Lectura IoT'}
                  </button>
                </div>

                <h4 className="text-2xl font-semibold text-gray-800 mb-6 text-center">Últimas Lecturas Recibidas</h4>
                {iotData.length === 0 ? (
                  <p className="text-gray-600 text-center">No hay datos IoT disponibles. Haz clic en 'Simular Nueva Lectura IoT' para empezar.</p>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                      <thead className="bg-green-100 text-green-800">
                        <tr>
                          <th className="py-3 px-4 text-left">CO2 (ppm)</th>
                          <th className="py-3 px-4 text-left">Hora</th>
                          <th className="py-3 px-4 text-left">ID de Usuario</th>
                        </tr>
                      </thead>
                      <tbody>
                        {iotData.map((data) => (
                          <tr key={data.id} className="border-b border-gray-200 last:border-b-0 hover:bg-gray-50">
                            <td className="py-3 px-4 flex items-center">
                              <CloudDrizzle className="h-5 w-5 text-gray-500 mr-2" />
                              {data.co2}
                            </td>
                            <td className="py-3 px-4">
                              {data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('es-ES') : 'N/A'}
                            </td>
                            <td className="py-3 px-4 text-sm text-gray-500 break-all">{data.userId}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            </section>

            {/* ML Recommendations Section (Summary on Home Page) */}
            <section id="ml-recommendations" className="container mx-auto py-16 px-4">
              <h3 className="text-3xl font-bold text-center text-green-700 mb-12">Recomendaciones Inteligentes (ML)</h3>
              <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center relative">
                {mlMessage && (
                  <div className={`mb-4 p-3 rounded-lg text-white ${mlMessage.includes('Error') ? 'bg-red-500' : 'bg-green-500'}`}>
                    {mlMessage}
                  </div>
                )}
                <p className="text-lg text-gray-700 mb-6">
                  Describe un escenario o haz una pregunta sobre sostenibilidad, y nuestra IA generará una recomendación.
                </p>
                <div className="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-8">
                  <textarea
                    className="w-full md:w-3/4 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 resize-y min-h-[100px]"
                    placeholder="Ej: 'Quiero reducir mi consumo de plástico en casa. ¿Qué puedo hacer?'"
                    value={mlPrompt}
                    onChange={(e) => setMlPrompt(e.target.value)}
                    rows="4"
                  ></textarea>
                  <button
                    onClick={getMlRecommendation}
                    disabled={mlLoading || !mlPrompt.trim()}
                    className="bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                  >
                    {mlLoading ? (
                      <>
                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generando...
                      </>
                    ) : (
                      <>
                        <Brain className="h-5 w-5 mr-2" />
                        Obtener Recomendación ML
                      </>
                    )}
                  </button>
                </div>

                {mlResponse && (
                  <div className="bg-green-50 p-6 rounded-lg text-left shadow-inner">
                    <h4 className="text-xl font-semibold text-green-800 mb-3 flex items-center">
                      <Leaf className="h-6 w-6 text-green-600 mr-2" />
                      Nuestra IA dice:
                    </h4>
                    <p className="text-gray-700 leading-relaxed whitespace-pre-wrap">{mlResponse}</p>
                  </div>
                )}
              </div>
            </section>

            {/* Call to Action Section */}
            <section className="bg-green-700 text-white py-16 px-4 text-center rounded-t-3xl">
              <h3 className="text-3xl font-bold mb-4">¡Únete a la Revolución Verde con Ecosín Digital!</h3>
              <p className="text-lg mb-8 max-w-2xl mx-auto">
                Sé parte del cambio. Descarga la aplicación y comienza a construir un futuro más sostenible para tu comunidad.
              </p>
              <button className="bg-white text-green-700 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-gray-100 transition duration-300 transform hover:scale-105">
                Próximamente en App Store y Google Play
              </button>
            </section>

            {/* Contact Section */}
            <section id="contacto" className="container mx-auto py-16 px-4">
              <h3 className="text-3xl font-bold text-center text-green-700 mb-12">Contáctanos</h3>
              <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="flex items-center space-x-4">
                  <Mail className="text-green-600 h-8 w-8" />
                  <div>
                    <h4 className="font-semibold text-gray-800">Email</h4>
                    <p className="text-gray-600">info@ecosin.com</p>
                  </div>
                </div>
                <div className="flex items-center space-x-4">
                  <Phone className="text-green-600 h-8 w-8" />
                  <div>
                    <h4 className="font-semibold text-gray-800">Teléfono</h4>
                    <p className="text-gray-600">+34 123 456 789</p>
                  </div>
                </div>
                <div className="md:col-span-2 text-center mt-6">
                  <p className="text-gray-700">O síguenos en nuestras redes sociales:</p>
                  <div className="flex justify-center space-x-6 mt-4">
                    <a href="#" className="text-gray-600 hover:text-green-600 transition duration-300">
                      {/* Placeholder for social media icons */}
                      <svg className="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.5 15h-2v-6h2v6zm3.5-6h-2v6h2v-6zm3-3h-2v9h2V8z"></path></svg> {/* Example generic social icon */}
                    </a>
                    <a href="#" className="text-gray-600 hover:text-green-600 transition duration-300">
                      <svg className="h-8 w-8" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.5 15h-2v-6h2v6zm3.5-6h-2v6h2v-6zm3-3h-2v9h2V8z"></path></svg>
                    </a>
                  </div>
                </div>
              </div>
            </section>
          </>
        );
      case 'register':
        return (
          <section id="registro" className="container mx-auto py-16 px-4 min-h-[60vh] flex items-center justify-center">
            <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center max-w-md w-full">
              <UserPlus className="text-green-600 h-20 w-20 mb-6 mx-auto" />
              <h3 className="text-3xl font-bold text-green-700 mb-6">Regístrate en Ecosín Digital</h3>
              {registerMessage && (
                <div className={`mb-4 p-3 rounded-lg text-white ${registerMessage.includes('Error') ? 'bg-red-500' : 'bg-green-500'}`}>
                  {registerMessage}
                </div>
              )}
              <form onSubmit={handleRegister}>
                <div className="mb-4 text-left">
                  <label htmlFor="reg-email" className="block text-gray-700 text-sm font-bold mb-2">Correo Electrónico:</label>
                  <input
                    type="email"
                    id="reg-email"
                    className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="tu@ejemplo.com"
                    value={registerEmail}
                    onChange={(e) => setRegisterEmail(e.target.value)}
                    required
                  />
                </div>
                <div className="mb-6 text-left">
                  <label htmlFor="reg-password" className="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                  <input
                    type="password"
                    id="reg-password"
                    className="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 mb-3 leading-tight focus:outline-none focus:ring-2 focus:ring-green-500"
                    placeholder="**********"
                    value={registerPassword}
                    onChange={(e) => setRegisterPassword(e.target.value)}
                    required
                  />
                </div>
                <button
                  type="submit"
                  disabled={registerLoading}
                  className="bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center w-full"
                >
                  {registerLoading ? (
                    <>
                      <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Registrando...
                    </>
                  ) : (
                    <>
                      <UserPlus className="h-5 w-5 mr-2" />
                      Registrarse
                    </>
                  )}
                </button>
              </form>
              <p className="mt-4 text-gray-600">¿Ya tienes una cuenta? <a href="#login" onClick={() => handleNavLinkClick('login')} className="text-green-600 hover:underline">Inicia Sesión aquí</a></p>
            </div>
          </section>
        );
      case 'login':
        return (
          <section id="login" className="container mx-auto py-16 px-4 min-h-[60vh] flex items-center justify-center">
            <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 text-center max-w-md w-full">
              <LogIn className="text-blue-600 h-20 w-20 mb-6 mx-auto" />
              <h3 className="text-3xl font-bold text-blue-700 mb-6">Inicia Sesión en Ecosín Digital</h3>
              <p className="text-gray-700 mb-4">Funcionalidad de inicio de sesión próximamente...</p>
              <button
                onClick={() => handleNavLinkClick('register')}
                className="bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 flex items-center justify-center w-full"
              >
                <UserPlus className="h-5 w-5 mr-2" />
                Registrarse (si no tienes cuenta)
              </button>
              <p className="mt-4 text-gray-600">Volver al <a href="#home" onClick={() => handleNavLinkClick('home', 'inicio')} className="text-green-600 hover:underline">Inicio</a></p>
            </div>
          </section>
        );
      case 'iotMonitor': // IoT Monitoring Page
        return (
          <section id="iot-monitor-page" className="container mx-auto py-16 px-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 relative">
              <button 
                onClick={() => handleNavLinkClick('home', 'inicio')}
                className="absolute top-4 left-4 bg-gray-200 text-gray-700 rounded-full p-2 hover:bg-gray-300 transition duration-300 flex items-center space-x-1"
              >
                <ArrowLeft className="h-5 w-5" />
                <span className="hidden md:inline">Volver al Inicio</span>
              </button>
              <h2 className="text-4xl font-bold text-green-700 text-center mb-10 mt-8 md:mt-0">
                Monitorización Ambiental en Tiempo Real
              </h2>
              <p className="text-lg text-gray-700 leading-relaxed max-w-3xl mx-auto text-center mb-8">
                Visualiza los datos de calidad del aire (CO2) recopilados por nuestros sensores IoT (datos simulados).
                Fomenta la conciencia y la acción informada en tu comunidad.
              </p>

              {message && (
                <div className={`mb-4 p-3 rounded-lg text-white ${message.includes('Error') ? 'bg-red-500' : 'bg-green-500'}`}>
                  {message}
                </div>
              )}
              <p className="text-sm text-gray-500 mb-4 text-center">
                **ID de Usuario:** {userId} (Este ID se utiliza para identificar tus datos en nuestra base de datos simulada y es visible a otros usuarios.)
              </p>
              <div className="flex justify-center items-center space-x-6 mb-8">
                <button
                  onClick={simulateIotReading}
                  disabled={loading || !db || !userId || userId === 'Cargando ID de usuario...'}
                  className="bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {loading ? 'Enviando...' : 'Simular Nueva Lectura IoT'}
                </button>
              </div>

              <h4 className="text-2xl font-semibold text-gray-800 mb-6 text-center">Últimas Lecturas Recibidas</h4>
              {iotData.length === 0 ? (
                <p className="text-gray-600 text-center">No hay datos IoT disponibles. Haz clic en 'Simular Nueva Lectura IoT' para empezar.</p>
              ) : (
                <div className="overflow-x-auto">
                  <table className="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead className="bg-green-100 text-green-800">
                      <tr>
                        <th className="py-3 px-4 text-left">CO2 (ppm)</th>
                        <th className="py-3 px-4 text-left">Hora</th>
                        <th className="py-3 px-4 text-left">ID de Usuario</th>
                      </tr>
                    </thead>
                    <tbody>
                      {iotData.map((data) => (
                        <tr key={data.id} className="border-b border-gray-200 last:border-b-0 hover:bg-gray-50">
                          <td className="py-3 px-4 flex items-center">
                            <CloudDrizzle className="h-5 w-5 text-gray-500 mr-2" />
                            {data.co2}
                          </td>
                          <td className="py-3 px-4">
                            {data.timestamp ? new Date(data.timestamp.toDate()).toLocaleTimeString('es-ES') : 'N/A'}
                          </td>
                          <td className="py-3 px-4 text-sm text-gray-500 break-all">{data.userId}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          </section>
        );
      case 'ecoChallengeGenerator': // Eco-Challenge Generator Page
        return (
          <section id="eco-challenge-generator-page" className="container mx-auto py-16 px-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 relative">
              <button 
                onClick={() => handleNavLinkClick('home', 'gamificacion')}
                className="absolute top-4 left-4 bg-gray-200 text-gray-700 rounded-full p-2 hover:bg-gray-300 transition duration-300 flex items-center space-x-1"
              >
                <ArrowLeft className="h-5 w-5" />
                <span className="hidden md:inline">Volver a Gamificación</span>
              </button>
              <h2 className="text-4xl font-bold text-green-700 text-center mb-10 mt-8 md:mt-0">
                Generador de Desafíos Ecológicos ✨
              </h2>
              <p className="text-lg text-gray-700 leading-relaxed max-w-3xl mx-auto text-center mb-8">
                ¡Deja que nuestra IA te inspire con retos personalizados para ser más sostenible!
                Describe el tipo de desafío que buscas (ej. "en casa", "para el transporte", "de reciclaje") y te daremos ideas.
              </p>

              {challengeMessage && (
                <div className={`mb-4 p-3 rounded-lg text-white ${challengeMessage.includes('Error') ? 'bg-red-500' : 'bg-green-500'}`}>
                  {challengeMessage}
                </div>
              )}

              <div className="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-8">
                <textarea
                  className="w-full md:w-3/4 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 resize-y min-h-[100px]"
                  placeholder="Ej: 'Un desafío semanal para reducir el consumo de energía'"
                  value={challengePrompt}
                  onChange={(e) => setChallengePrompt(e.target.value)}
                  rows="4"
                ></textarea>
                <button
                  onClick={generateEcoChallenge}
                  disabled={challengeLoading || !challengePrompt.trim()}
                  className="bg-purple-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                >
                  {challengeLoading ? (
                    <>
                      <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Generando...
                    </>
                  ) : (
                    <>
                      <Zap className="h-5 w-5 mr-2" />
                      Generar Desafío
                    </>
                  )}
                </button>
              </div>

              {challengeResponse && (
                <div className="bg-purple-50 p-6 rounded-lg text-left shadow-inner">
                  <h4 className="text-xl font-semibold text-purple-800 mb-3 flex items-center">
                    <Trophy className="h-6 w-6 text-purple-600 mr-2" />
                    ¡Tu Desafío de Ecosín!
                  </h4>
                  <p className="text-gray-700 leading-relaxed whitespace-pre-wrap">{challengeResponse}</p>
                </div>
              )}

              <div className="text-center mt-12">
                <button 
                  onClick={() => handleNavLinkClick('home', 'gamificacion')}
                  className="bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 flex items-center justify-center mx-auto"
                >
                  <ArrowLeft className="h-5 w-5 mr-2" /> Volver a Gamificación
                </button>
              </div>
            </div>
          </section>
        );
      case 'ecoEventGenerator': // New Eco-Event Generator Page
        return (
          <section id="eco-event-generator-page" className="container mx-auto py-16 px-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 relative">
              <button 
                onClick={() => handleNavLinkClick('home', 'gamificacion')} 
                className="absolute top-4 left-4 bg-gray-200 text-gray-700 rounded-full p-2 hover:bg-gray-300 transition duration-300 flex items-center space-x-1"
              >
                <ArrowLeft className="h-5 w-5" />
                <span className="hidden md:inline">Volver</span>
              </button>
              <h2 className="text-4xl font-bold text-green-700 text-center mb-10 mt-8 md:mt-0">
                Generador de Ideas de Eventos Sostenibles ✨
              </h2>
              <p className="text-lg text-gray-700 leading-relaxed max-w-3xl mx-auto text-center mb-8">
                ¡Inspírate para organizar eventos ecológicos! Describe el tipo de evento que imaginas (ej. "limpieza de parque", "taller de compostaje", "feria de productos locales").
              </p>

              {eventMessage && (
                <div className={`mb-4 p-3 rounded-lg text-white ${eventMessage.includes('Error') ? 'bg-red-500' : 'bg-green-500'}`}>
                  {eventMessage}
                </div>
              )}

              <div className="flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4 mb-8">
                <textarea
                  className="w-full md:w-3/4 p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 resize-y min-h-[100px]"
                  placeholder="Ej: 'Un evento de reforestación urbana para jóvenes'"
                  value={eventPrompt}
                  onChange={(e) => setEventPrompt(e.target.value)}
                  rows="4"
                ></textarea>
                <button
                  onClick={generateEcoEventIdea}
                  disabled={eventLoading || !eventPrompt.trim()}
                  className="bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                >
                  {eventLoading ? (
                    <>
                      <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Generando...
                    </>
                  ) : (
                    <>
                      <CalendarCheck className="h-5 w-5 mr-2" />
                      Generar Idea de Evento
                    </>
                  )}
                </button>
              </div>

              {eventResponse && (
                <div className="bg-blue-50 p-6 rounded-lg text-left shadow-inner">
                  <h4 className="text-xl font-semibold text-blue-800 mb-3 flex items-center">
                    <CalendarCheck className="h-6 w-6 text-blue-600 mr-2" />
                    ¡Aquí tienes tu Idea de Evento Sostenible!
                  </h4>
                  <p className="text-gray-700 leading-relaxed whitespace-pre-wrap">{eventResponse}</p>
                </div>
              )}

              <div className="text-center mt-12">
                <button 
                  onClick={() => handleNavLinkClick('home', 'gamificacion')}
                  className="bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 flex items-center justify-center mx-auto"
                >
                  <ArrowLeft className="h-5 w-5 mr-2" /> Volver
                </button>
              </div>
            </div>
          </section>
        );
      case 'detailedOverview': // Consolidated Detailed Overview Page (from AboutApp)
        return (
          <section id="detailed-overview-page" className="container mx-auto py-16 px-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 relative">
              <button 
                onClick={() => handleNavLinkClick('home', 'inicio')}
                className="absolute top-4 left-4 bg-gray-200 text-gray-700 rounded-full p-2 hover:bg-gray-300 transition duration-300 flex items-center space-x-1"
              >
                <ArrowLeft className="h-5 w-5" />
                <span className="hidden md:inline">Volver al Inicio</span>
              </button>
              <h2 className="text-4xl font-bold text-green-700 text-center mb-10 mt-8 md:mt-0">
                Explora Ecosín Digital: Una Plataforma para la Acción Climática
              </h2>

              <div className="mb-12">
                <h3 className="text-3xl font-bold text-green-700 mb-6 text-center">Nuestra Misión</h3>
                <p className="text-lg text-gray-700 leading-relaxed max-w-3xl mx-auto text-center">
                  Ecosín Digital es una plataforma pionera e integral que busca **catalizar la acción climática local** y empoderar a los ciudadanos. Transformamos la conciencia ambiental pasiva en una **participación activa y medible** en la reducción de la huella de carbono y la mejora de la calidad ambiental urbana. Combinamos tecnologías de vanguardia para ofrecer una solución única y efectiva.
                </p>
              </div>

              <h3 className="text-3xl font-bold text-center text-green-700 mb-12">Nuestros Pilares Tecnológicos Principales</h3> {/* Simplified title */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-10 mb-12"> {/* Adjusted grid for 2 columns */}
                {/* Feature 1: IoT Summary */}
                <div className="bg-green-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Cloud className="text-blue-600 h-16 w-16 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Internet de las Cosas (IoT)</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Red de sensores para monitorización en tiempo real de calidad del aire, ruido, temperatura y humedad. Fomenta la ciencia ciudadana.
                  </p>
                </div>

                {/* Feature 2: ML Summary */}
                <div className="bg-blue-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Brain className="text-purple-600 h-16 w-16 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Aprendizaje Automático (ML)</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Genera recomendaciones personalizadas y predictivas para la acción climática y el ahorro de recursos.
                  </p>
                </div>

                {/* Feature 3: Gamificación Summary */}
                <div className="bg-yellow-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Trophy className="text-amber-600 h-16 w-16 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Gamificación</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Transforma la sostenibilidad en un juego con puntos, niveles, desafíos y recompensas, motivando a la acción.
                  </p>
                </div>

                {/* Feature 4: RA Summary */}
                <div className="bg-purple-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Camera className="text-indigo-600 h-16 w-16 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Realidad Aumentada (RA)</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Ofrece educación ambiental inmersiva y contextualizada, haciendo el impacto visible en el entorno real.
                  </p>
                </div>
              </div>

              {/* Button to go to detailed features page */}
              <div className="text-center mt-12">
                <button 
                  onClick={() => handleNavLinkClick('featuresDetailedPage')}
                  className="bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 flex items-center justify-center mx-auto"
                >
                  <Eye className="h-5 w-5 mr-2" /> Ver Características en Detalle
                </button>
              </div>
            </div>
          </section>
        );
      case 'featuresDetailedPage': // New dedicated Detailed Features Page
        return (
          <section id="features-detailed-page" className="container mx-auto py-16 px-4">
            <div className="bg-white rounded-2xl shadow-xl p-8 md:p-12 relative">
              <button 
                onClick={() => handleNavLinkClick('home', 'inicio')} // Back to home
                className="absolute top-4 left-4 bg-gray-200 text-gray-700 rounded-full p-2 hover:bg-gray-300 transition duration-300 flex items-center space-x-1"
              >
                <ArrowLeft className="h-5 w-5" />
                <span className="hidden md:inline">Volver al Inicio</span>
              </button>
              <h2 className="text-4xl font-bold text-green-700 text-center mb-10 mt-8 md:mt-0">
                Características Detalladas de Ecosín Digital
              </h2>
              <p className="text-lg text-gray-700 leading-relaxed max-w-3xl mx-auto text-center mb-12">
                Ecosín Digital integra tecnologías de vanguardia para ofrecer una experiencia completa y motivadora en tu viaje hacia la sostenibilidad.
              </p>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-12">
                {/* Detailed Feature 1: Monitorización Ambiental (IoT) */}
                <div className="bg-green-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Cloud className="text-blue-600 h-20 w-20 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Internet de las Cosas (IoT): Datos Ambientales en Tiempo Real</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Nuestra **Red de Sensores Colaborativa y Diversificada** recoge datos precisos de **calidad del aire (CO2, PM2.5), ruido, temperatura y humedad** en puntos clave de tu ciudad. Estos datos, accesibles en tiempo real, te permiten visualizar la salud de tu entorno y comprender el impacto de tus acciones diarias. Fomentamos la **ciencia ciudadana** para enriquecer esta red, convirtiendo a los ciudadanos en generadores activos de información.
                  </p>
                </div>

                {/* Detailed Feature 2: Aprendizaje Automático (ML) */}
                <div className="bg-blue-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Brain className="text-purple-600 h-20 w-20 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Aprendizaje Automático (ML): Inteligencia para la Personalización</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Nuestra **Plataforma de Machine Learning** analiza grandes volúmenes de datos para ofrecer **recomendaciones hiper-personalizadas y adaptativas** sobre cómo reducir tu huella de carbono. Además, implementamos **predicción de impacto** para que veas el potencial de tus acciones antes de realizarlas y **IA Generativa para Contenido Educativo** que responde a tus preguntas ambientales de forma sencilla y atractiva.
                  </p>
                </div>

                {/* Detailed Feature 3: Gamificación */}
                <div className="bg-yellow-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Trophy className="text-amber-600 h-20 w-20 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Gamificación: Transformando la Sostenibilidad en un Juego</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Utilizamos **Mecánicas de Motivación Intrínseca Avanzadas** para que cada acción cuente. Gana puntos, insignias y sube de nivel al completar **desafíos dinámicos y contextualizados** que te motivan a adoptar hábitos sostenibles. Fomentamos la **economía circular de recompensas** colaborando con negocios locales y permitiendo que los usuarios donen sus puntos a proyectos ambientales.
                  </p>
                </div>

                {/* Detailed Feature 4: Realidad Aumentada (RA) */}
                <div className="bg-purple-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Camera className="text-indigo-600 h-20 w-20 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Realidad Aumentada (RA): Educación Inmersiva y Contextualizada</h4>
                  <p className="text-gray-700 leading-relaxed">
                    La **RA** te permite interactuar con el mundo real de una forma única. Escanea elementos de tu ciudad para visualizar información ambiental, aprender sobre su impacto y descubrir formas de contribuir a un entorno más verde. Ofrecemos **integración de datos en tiempo real en RA** para ver niveles de CO2 flotando sobre una calle y **simulaciones de impacto y escenarios futuros** para visualizar cómo tus acciones transforman tu entorno.
                  </p>
                </div>

                {/* Detailed Feature 5: Calculadora de Huella de Carbono */}
                <div className="bg-orange-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Calculator className="text-gray-600 h-20 w-20 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Calculadora de Huella de Carbono Personal</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Calcula y monitorea tu impacto personal en el medio ambiente. Esta herramienta te ayuda a identificar las áreas donde puedes reducir tu huella de carbono y te permite establecer objetivos claros para un futuro más verde.
                  </p>
                </div>

                {/* Detailed Feature 6: Comunidad y Eventos Locales */}
                <div className="bg-teal-50 rounded-2xl shadow-lg p-6 flex flex-col items-center text-center">
                  <Users className="text-green-600 h-20 w-20 mb-4" />
                  <h4 className="text-2xl font-semibold text-gray-800 mb-3">Comunidad y Eventos Locales</h4>
                  <p className="text-gray-700 leading-relaxed">
                    Participa en eventos de sostenibilidad organizados en tu ciudad, conéctate con otros usuarios, comparte ideas y forma parte de una comunidad activa comprometida con el medio ambiente. Fomentamos la acción colectiva.
                  </p>
                </div>
              </div>

              {/* Back to Home Button */}
              <div className="text-center mt-12">
                <button 
                  onClick={() => handleNavLinkClick('home', 'inicio')}
                  className="bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-green-700 transition duration-300 transform hover:scale-105 flex items-center justify-center mx-auto"
                >
                  <ArrowLeft className="h-5 w-5 mr-2" /> Volver al Inicio
                </button>
              </div>
            </div>
          </section>
        );
      default:
        return null;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-blue-100 font-sans text-gray-800">
      {/* Script para cargar Tailwind CSS */}
      <script src="https://cdn.tailwindcss.com"></script>
      {/* Configuración de la fuente Inter */}
      <style>
        {`
          @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
          body {
            font-family: 'Inter', sans-serif;
          }
          /* Custom fade-in for mobile menu */
          .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
          }
          @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
          }
        `}
      </style>

      {/* Header */}
      <header className="bg-white shadow-sm p-4 sticky top-0 z-10">
        <nav className="container mx-auto flex justify-between items-center px-4">
          <div className="flex items-center space-x-2">
            <Leaf className="text-green-600 h-8 w-8" />
            {/* Make the Ecosín Digital text a clickable link to home */}
            <a href="#inicio" onClick={() => handleNavLinkClick('home', 'inicio')} className="text-2xl font-bold text-green-700 hover:text-green-800 transition duration-300">
              Ecosín Digital
            </a>
          </div>
          {/* Mobile menu button - now always visible as the primary navigation toggle */}
          <button
            className="text-gray-600 hover:text-green-600 focus:outline-none"
            onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
          >
            {/* Adjusted size to h-5 w-5 */}
            {isMobileMenuOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
          </button>
        </nav>
      </header>

      {/* Mobile Menu Overlay - Changed from full screen to a small box on the right */}
      {isMobileMenuOpen && (
        <div className="fixed top-16 right-4 bg-white bg-opacity-95 z-20 flex flex-col items-start p-4 rounded-lg shadow-xl animate-fade-in
                      min-w-[200px] max-w-[calc(100%-32px)] max-h-[calc(100vh-80px)] overflow-y-auto">
          <nav className="flex flex-col space-y-3 text-left w-full">
            {/* Main navigation links */}
            <a href="#inicio" className="text-gray-800 hover:text-green-600 font-medium transition duration-300 py-1" onClick={() => handleNavLinkClick('home', 'inicio')}>Inicio</a>
            <a href="#detailedOverview" className="text-green-700 hover:text-green-800 font-semibold transition duration-300 py-1 flex items-center" onClick={() => handleNavLinkClick('detailedOverview')}>
              <Lightbulb className="h-5 w-5 mr-2" /> Sobre Ecosín
            </a> 
            <a href="#featuresDetailedPage" className="text-gray-800 hover:text-green-600 font-medium transition duration-300 py-1" onClick={() => handleNavLinkClick('featuresDetailedPage')}>Características</a> 
            <a href="#iot-monitor" className="text-gray-800 hover:text-green-600 font-medium transition duration-300 py-1" onClick={() => handleNavLinkClick('iotMonitor')}>Datos IoT</a>
            <a href="#ml-recommendations" className="text-gray-800 hover:text-green-600 font-medium transition duration-300 py-1" onClick={() => handleNavLinkClick('home', 'ml-recommendations')}>ML Recom.</a>
            <a href="#gamificacion" className="text-gray-800 hover:text-green-600 font-medium transition duration-300 py-1" onClick={() => handleNavLinkClick('home', 'gamificacion')}>Gamificación</a>
            <a href="#realidad-aumentada" className="text-gray-800 hover:text-green-600 font-medium transition duration-300 py-1" onClick={() => handleNavLinkClick('home', 'realidad-aumentada')}>RA</a>
            <a href="#contacto" className="text-gray-800 hover:text-green-600 font-medium transition duration-300 py-1" onClick={() => handleNavLinkClick('home', 'contacto')}>Contacto</a>
            <div className="border-t border-gray-200 my-2"></div>
            {/* Specific action links */}
            <a href="#eco-challenge-generator" className="text-purple-600 hover:text-purple-800 font-semibold transition duration-300 py-1 flex items-center" onClick={() => handleNavLinkClick('ecoChallengeGenerator')}>
              <Zap className="h-5 w-5 mr-2" /> Generador de Desafíos ✨
            </a>
            <a href="#eco-event-generator" className="text-blue-600 hover:text-blue-800 font-semibold transition duration-300 py-1 flex items-center" onClick={() => handleNavLinkClick('ecoEventGenerator')}>
              <CalendarCheck className="h-5 w-5 mr-2" /> Ideas de Eventos ✨
            </a>
            <a href="#register" className="text-green-600 hover:text-green-800 font-semibold transition duration-300 py-1 flex items-center" onClick={() => handleNavLinkClick('register')}>
              <UserPlus className="h-5 w-5 mr-2" /> Registrarse
            </a>
            <a href="#login" className="text-blue-600 hover:text-blue-800 font-semibold transition duration-300 py-1 flex items-center" onClick={() => handleNavLinkClick('login')}>
              <LogIn className="h-5 w-5 mr-2" /> Iniciar Sesión
            </a>
          </nav>
        </div>
      )}

      {renderContent()}

      {/* Footer is always visible regardless of view */}
      <footer className="bg-gray-800 text-white py-8 px-4 text-center rounded-t-2xl">
        <p>&copy; 2025 Ecosín Digital. Todos los derechos reservados.</p>
        <div className="mt-4 space-x-4">
          <a href="#" className="text-gray-300 hover:text-white transition duration-300">Política de Privacidad</a>
          <a href="#" className="text-gray-300 hover:text-white transition duration-300">Términos de Servicio</a>
        </div>
      </footer>
    </div>
  );
};

export default App;
